## 주키퍼의 기본

---

- 코디네이션이 필요한 서비스를 만드는 방법
    - 기본 요소 목록을 작성
    - 각 기본 요소의 인스턴스를 생성하는 호출을 제공
    - 생성된 인스턴스를 직접 조작

- 분산 락은 핵심 기본 요소이고, 생성, 획득, 해제에 대한 호출을 제공한다.

- 주의사항
    - 미리 빠짐없이 기본 요소 목록을 찾아내지 않으면 새로운 기본 요소를 도입하기 위해 API를 계속해서 추가해야 한다.
    - 기본 요소를 특정 서비스에만 적합하게 구현한 서비스를 사용하는 애플리케이션은 유연성을 제공하지 못한다.

<br />

### 주키퍼의 접근 방법

- 기본 요소를 직접 제공하지 않는 대신 애플리케이션이 직접 기본 요소를 구현할 수 있는 호출들로 구성된 파일 시스템과 같은 API 를 제공한다.
- 주키퍼는 기본 요소를 표현하기 위해 레시피를 사용한다.
    - 레시피 : 파일 시스템의 트리(tree) 처럼 계층적으로 구성된 znode 라고 부르는 작은 데이터 노드를 조작하는 주키퍼 작업(operation) 이다.
- 가끔 znode 의 데이터가 없는 것은 현재 선출된 마스터가 없다는 의미이다.

<br />

### Node 의 종류

- /workes
    - /works znode 는 부모 znode 로 시스템상에서 가용한 워커의 정보를 담고 있는 znode 이다.
    - 일을 할 수 있는 모듈의 정보를 갖고 있는 znode
- /tasks
    - /tasks znode 는 워커가 실행할 작업이 생성되어 실행 전까지 저장되는 부모 znode 이다.
    - 마스터 워커 애플리케이션의 클라이언트는 신규 작업을 의미하는 신규 znode 를 /tasks 노드의 자식 노드로 추가하고 작업의 상태를 나타내는 znode 를 가리킨다.
    - 작업 대상에 대한 정보를 갖고 있는 znode
- /assign
    - /assign znode 는 워커에게 할당된 모든 작업을 나타내는 부모 znode 이다.
    - 마스터가 워커를 할당할 때 /assign 에 자식 znode 를 할당한다.
    - 어떤 워커가 어떤 작업을 하는지에 대한 정보를 갖고 있는 znode

<br />

## 주키퍼 API

---

- znode 는 데이터를 담거나 담고 있지 않을 수 있다.
- znode 에 데이터가 담겨 있는 경우 데이터는 바이트 배열 (byte array) 로 저장된다.
- 바이트 배열의 포맷은 각 애플리케이션에서 정의한다.
- 경우에 따라 UTF-8, ASCII 와 같은 문자열 인코딩이 필요하다.
- 주키퍼 클라이언트는 주키퍼 서비스에 연결하고 API 호출을 통해 세션을 맺는다.

<br />

### API 의 종류

- create /path data
    - data 를 담고 있는 /path 라는 이름의 znode 를 생성한다.
- delete /path
    - /path znode 를 삭제한다.
- exists /path
    - /path znode 가 존재하는지 확인한다.
- setData /path data
    - /path znode 의 데이터를 data로 저장한다.
- getData /path
    - /path 의 데이터를 반환한다.
- getChildren /path
    - /path 의 자식 목록을 반환한다.

<br />

### Znode 의 다양한 모드

- znode 는 영구적 (persistent) 이거나 임시적 (ephemeral) 으로 존재할 수 있다.


- 영구 znode
    - /path 는 delete 를 호출함으로써 삭제할 수 있다.
    - 애플리케이션 데이터를 저장하는데 유용하다.
    - 애플리케이션이 더 이상 사용할 수 없게 되어도 보존한다.
    - 마스터가 작업을 할당하고 장애가 발생해도 워커에게 할당된 작업들을 유지해야 한다.


- 임시 znode
    - znode 를 생성한 클라이언트가 주키퍼와 클라이언트의 연결이 끊어지거나 클라이언트 장애가 발생하게 되면 삭제된다.
    - 애플리케이션의 특정 관점에 대한 정보를 저장한다.
    - 임시 znode 는 znode를 생성한 클라이언트의 세션이 존재하는 동안 유효하다.
    - 마스터 워커 예제에서 마스터 znode 는 임시 znode 이다.
        - 마스터 znode 가 존재한다는 것은 마스터가 실행 중임을 의미한다.
        - 마스터가 문제가 발생했을 때 마스터 znode 가 존재한다면 시스템은 마스터 장애를 감지하지 못할 것이다.
        - 마스터 znode 는 반드시 마스터와 함께 제거되어야 한다.
    - 워커 역시 임시 znode 를 사용한다.
        - 워커가 이용 불가능해진다면 워커와 주키퍼 간의 세션은 만료되고 /workes 내의 워커를 나타내는 znode 는 자동으로 사라진다.
    - 임시 znode 는 다음과 같은 두가지 경우에 삭제된다.
        - 임시 znode 를 생성한 클라이언트의 세션이 만료되거나 명시적으로 세션이 끝나는 경우
        - 클라이언트가 삭제한 경우
    - znode를 생성한 클라이언트의 세션이 만료되면 임시 znode 가 삭제되기 때문에 현재 임시 znode 는 자식 znode 를 가질 수 없다.


- 순차 znode (sequential)
  - znode 는 순차적으로 생성될 수 있다.
  - 순차 znode 는 유일하면서 점차 증가하는 정수로 할당된다.
  - 이 순차 번호는 znode 를 생성할 때 사용되는 경로에 덧붙여진다.
    - /tasks/task-1


- znode 는 영구, 임시, 영구순차, 임시순차 노드로 4가지 선택사항이 있다.


<br /><br />

## 와치와 알림

---

- 주키퍼는 클라이언트의 폴링 (매번 이벤트의 발생여부를 체크해야하는) 을 대체하기 위해 알림에 기반한 메커니즘을 선택했다.
- 클라이언트는 주키퍼에게 znode 의 변경 사항에 대한 알림을 받겠다고 등록한다.
- 와치(watch) 를 설정하는 것으로 znode 에 대한 알림 받기가 등록된다.
- 와치는 알림이 한 번만 발생하는 일회성 (one-shot) 작업이다.
- 계속해서 알림을 받으려면 클라이언트는 받고자 하는 각 알림마다 반드시 새로운 와치를 설정해야 한다.
- 클라이언트는 /tasks znode 값의 변경을 나타내는 알림을 받으면 주키퍼에서 새로운 값을 읽어온다.

### 주의사항

- 클라이언트가 알림을 받고 새로운 와치를 등록하기 이전에 신규 변경 사항이 생기는 현상이 발생할 수 있음
  - 클라이언트 c1 이 새로운 와치를 설정하기 이전에 또 다른 세 번째 클라이언트 c3 가 신규 작업을 /tasks 에 등록한다.

- 주키퍼의 알림이 확실하게 보장하는 것은 동일한 znode 에 대해 다른 변경 사항이 생기기 이전에 클라이언트에게 전달된다는 것
- 알림은 클라이언트가 감시하고 있는 znode 의 변경 사항의 순서를 보존한다는 것이다.
- 주키퍼에게 관리되는 전역 순서에 따라 클라이언트는 주키퍼의 상태 변경 사항을 순서대로 감시하는 것이 보장된다.
  - 첫 번째 변경사항에 대한 이벤트 발생 후 , 와치를 재 등록해야 다음 변경사항에 대한 알림을 받을 수 있기 때문이다.

### 주키퍼 알림의 이벤트 유형

- 주키퍼는 와치가 설정하는 알림에 따라 다른 유형의 알림을 보낸다.
  - 클라이언트는 znode 의 데이터가 변경되었을 때
  - 자식 znode 가 변경되었을 때
  - znode가 생성되거나 삭제 되었을 때
- 주키퍼의 상태를 읽는 API 호출로 와치를 설정할 수 있다.

<br /><br />